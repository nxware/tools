<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Drag & Drop → JPG Download</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{min-height:100vh;display:flex;align-items:center;justify-content:center;background:#f3f4f6;margin:0;padding:24px}
    .card{background:white;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.08);width:820px;max-width:100%;padding:20px}
    .drop{border:2px dashed #d1d5db;border-radius:8px;padding:28px;display:flex;gap:16px;align-items:center;justify-content:center;flex-direction:column;min-height:220px;transition:background .15s, border-color .15s}
    .drop.dragover{background:#eef2ff;border-color:#6366f1}
    .hint{color:#6b7280}
    .controls{display:flex;gap:12px;align-items:center;margin-top:14px}
    input[type=range]{width:160px}
    .preview{margin-top:14px;display:flex;gap:16px;align-items:flex-start}
    .preview img{max-width:280px;max-height:200px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.06)}
    .meta{flex:1}
    button{background:#4f46e5;color:white;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    button:disabled{opacity:.5;cursor:default}
    .small{font-size:13px;color:#374151}
    label{font-size:13px;color:#374151}
    .row{display:flex;gap:8px;align-items:center}
  
    /* Dark Mode Styles */
    body.dark{background:#1f2937;color:#e5e7eb;}
    body.dark .card{background:#111827;color:#e5e7eb;box-shadow:0 6px 18px rgba(0,0,0,0.5);}    
    body.dark .drop{border-color:#4b5563;background:#1f2937;}    
    body.dark .drop.dragover{background:#374151;border-color:#818cf8;}   
    body.dark .hint{color:#9ca3af;}    
    body.dark .small{color:#d1d5db;}    
    body.dark button{background:#6366f1;color:white;}    
    body.dark input, body.dark select, body.dark number{background:#374151;color:#e5e7eb;border-color:#4b5563;}    
  </style>
</head>
<body class="dark">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;"><h2>Bild per Drag &amp; Drop hochladen und als JPG herunterladen</h2>
      <label class="small" style="display:flex;align-items:center;gap:6px;cursor:pointer;">Dark&nbsp;Mode <input id="darkToggle" type="checkbox" checked></label></div>
    <p class="hint">Ziehe ein einzelnes Bild in die Box oder klicke, um ein Bild auszuwählen.</p>

    <div id="drop" class="drop">
      <div id="dropInner">
        <strong>Bild hierhin ziehen</strong>
        <div class="hint">oder <button id="pickBtn" type="button">Datei wählen</button></div>
      </div>
      <input id="fileInput" type="file" accept="image/*" style="display:none">
    </div>

    <div class="controls">
      <label class="row small">Wasserzeichen:
        <input id="watermark" type="text" placeholder="optional" style="width:160px;margin-left:6px;">
      </label>
      <label class="row small">Qualität: <span id="qLabel">0.92</span></label>
      <input id="quality" type="range" min="0.1" max="1" step="0.01" value="0.92">

      <label class="row small">Max Kanten (px):
        <input id="maxSide" type="number" min="0" value="0" style="width:84px;margin-left:6px;"> <span class="hint" style="margin-left:6px">(0=original)</span>
      </label>
    </div>
    <div class="controls" style="text-align: center;">
      <button id="downloadBtn" disabled>Als JPG herunterladen</button>
    </div>

    <div class="preview">
      <img id="previewImg" alt="Vorschau" src="" style="display:none">
      <div class="meta">
        <div id="info" class="small">Keine Datei geladen</div>
      </div>
    </div>

    <canvas id="hiddenCanvas" style="display:none"></canvas>
  </div>

<script>
(function(){
  const darkToggle = document.getElementById('darkToggle');
  darkToggle.addEventListener('change', ()=>{
    document.body.classList.toggle('dark', darkToggle.checked);
  });

  const drop = document.getElementById('drop');
  const fileInput = document.getElementById('fileInput');
  const pickBtn = document.getElementById('pickBtn');
  const previewImg = document.getElementById('previewImg');
  const info = document.getElementById('info');
  const quality = document.getElementById('quality');
  const qLabel = document.getElementById('qLabel');
  const downloadBtn = document.getElementById('downloadBtn');
  const maxSide = document.getElementById('maxSide');
  const canvas = document.getElementById('hiddenCanvas');

  let currentFile = null;

  function prevent(e){ e.preventDefault(); e.stopPropagation(); }
  ['dragenter','dragover','dragleave','drop'].forEach(evt => drop.addEventListener(evt, prevent));

  ['dragenter','dragover'].forEach(evt => drop.addEventListener(evt, ()=> drop.classList.add('dragover')));
  ['dragleave','drop'].forEach(evt => drop.addEventListener(evt, ()=> drop.classList.remove('dragover')));

  drop.addEventListener('drop', (e)=>{
    const f = (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]);
    if(f) handleFile(f);
  });

  pickBtn.addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', ()=> {
    if(fileInput.files && fileInput.files[0]) handleFile(fileInput.files[0]);
  });

  quality.addEventListener('input', ()=> qLabel.textContent = quality.value);

  function handleFile(file){
    if(!file.type.startsWith('image/')){
      alert('Bitte eine Bilddatei wählen.');
      return;
    }
    currentFile = file;
    info.textContent = `${file.name} — ${(file.size/1024).toFixed(1)} KB — ${file.type}`;

    const reader = new FileReader();
    reader.onload = ()=>{
      previewImg.src = reader.result;
      previewImg.style.display = '';
      downloadBtn.disabled = false;
    };
    reader.readAsDataURL(file);
  }

  downloadBtn.addEventListener('click', async ()=>{
    if(!currentFile) return;
    // create image element to load full-size pixels
    const img = new Image();
    img.onload = ()=>{
      // determine target size
      let targetW = img.naturalWidth;
      let targetH = img.naturalHeight;
      const max = Number(maxSide.value) || 0;
      if(max > 0){
        const ratio = Math.min(1, max / Math.max(targetW, targetH));
        targetW = Math.round(targetW * ratio);
        targetH = Math.round(targetH * ratio);
      }

      canvas.width = targetW;
      canvas.height = targetH;
      const ctx = canvas.getContext('2d');

      // fill white background to avoid transparency black in JPG
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // draw image into canvas
      ctx.drawImage(img, 0, 0, targetW, targetH);

      // add watermark if provided
      const wm = document.getElementById('watermark').value.trim();
      if(wm){
        const fontSize = Math.round(targetW * 0.03);
        ctx.font = `${fontSize}px sans-serif`;
        ctx.fillStyle = 'rgba(255,255,255,0.8)';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'bottom';
        ctx.fillText(wm, targetW - 10, targetH - 10);
      }

      // convert to blob JPG
      const q = Number(quality.value);
      canvas.toBlob((blob)=>{
        if(!blob){ alert('Fehler beim Erstellen der JPG-Datei'); return; }
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const name = currentFile.name.replace(/\.[^\.]+$/, '') + '.jpg';
        a.href = url;
        a.download = name;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=> URL.revokeObjectURL(url), 30000);
      }, 'image/jpeg', q);
    };
    // load as data URL (preview already has it) — use URL to avoid double FileReader if possible
    // but to keep simple, use FileReader again to ensure fresh load
    const fr = new FileReader();
    fr.onload = ()=> img.src = fr.result;
    fr.readAsDataURL(currentFile);
  });

  // Accessibility: allow click on drop area
  drop.addEventListener('click', ()=> fileInput.click());

})();
</script>
</body>
</html>
